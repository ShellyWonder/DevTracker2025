@* ProjectDetails *@
@page "/projects/{ProjectId:int}"
@attribute [Authorize]

@inject IProjectDTOService ProjectService
@inject ICompanyDTOService CompanyService
@inject IAppAuthorizationService AuthService
@inject IndexTrackerHelper IndexTracker
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

@inherits AuthenticatedComponentBase

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4 page-container" Style="height: 100%; position: relative">
	<MudBreadcrumbs Items="breadcrumbs" Class="breadcrumbs1" />
	@if (!_loadingComplete)
	{
		<LoadingSpinner Message="Loading project details..." Color="Color.Primary" Size="Size.Large" />
	}
	else if (_project is not null)
	{
		@* Reset Index at start of render;
					controls the index for components that use IndexTracker.*@
		ResetIndex();
		<PageTitle>@_project?.Name Details | Dev Tracker</PageTitle>

		<div class="vstack gap-3">

			<!-- Sibling A: General Info (bind PM) -->
			<ProjectGeneralInfo Project="_project"
								Index="@IndexTracker.Next()"
								ProjectManagers="projectManagers"
								@bind-ProjectManagerId="_project.ProjectManagerId"
								OnSaveProjectManagerRequested="HandleSavePMAsync" />

			<DescriptionCard Title="Description"
							 Index="@IndexTracker.Next()"
							 Text="@_project.Description" />

			<!-- Sibling B: receive the same 'project' plus a refresh token -->
			<ProjectMembers UserCanManageTeam="_userCanEditProject"
							Project="_project"
							RefreshToken="_membersRefreshToken"
							Index="@IndexTracker.Next()" />

			<ProjectTickets Project="_project" Index="@IndexTracker.Next()" />

		</div>

		<div class="d-flex mt-2">
			<BackToBtn Href="/projects" Text="Back to Projects" Disabled="@(_project is null)" />
			@if (_userCanEditProject)
			{
				<div class="ms-auto">
					<MudButton Variant="Variant.Text"
							   StartIcon="@Icons.Material.Filled.Edit"
							   Href="@($"projects/{ProjectId}/edit")"
							   Disabled="@(_project is null || !_userCanEditProject)"
							   Color="Color.Tertiary">
						Edit
					</MudButton>

					<ArchiveBar IsArchived="_project!.Archived"
								UserCanArchiveAndRestore="_userCanEditProject"
								ItemLabel="Project"
								Busy="@_processingRequest"
								OnArchiveRequested="HandleArchiveAsync"
								OnRestoreRequested="HandleRestoreAsync" />
				</div>

			}
		</div>
	}
	else
	{
		<PageTitle>Project Not Found | Dev Tracker</PageTitle>

		<NotFoundFull Message="Project not found"
					  ReturnUrl="/projects"
					  ReturnLabel="Back to Projects"
					  ForwardUrl="/projects/create"
					  ForwardLabel="Create New Project" />

	}
</MudContainer>



