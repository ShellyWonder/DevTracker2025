@*AttachmentCard *@
@inject IDialogService DialogService
@inherits AuthenticatedComponentBase

@if (Attachment is not null)
{
	<MudCard Class="h-100">
		
		<MudCardMedia Image="@($"/img/attachmentsPNGs/png/{extension}.png")"
					  Height="96"
					  Style="background-size:contain; border: 6px inset transparent;" />
		<MudCardContent>
			<MudText Typo="Typo.body1"  Color="Color.Primary" Align="Align.Center" Class="text-truncate">@Attachment.FileName</MudText>
			<MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">@Attachment.User?.FullName</MudText>
			<MudCollapse Expanded="isDescriptionExpanded">
				<MudText Typo="Typo.body2"Class="py-2">
					@Attachment.Description
					</MudText>
				<MudText Typo="Typo.caption"Class="py-2">
					@Attachment.Created.ToString("g")
					</MudText>
			</MudCollapse>
		</MudCardContent>
		<MudCardActions>
			<!-- Collapse Toggle -->
			<SafeNavButton EndIcon="@Icons.Material.Filled.Info"
						   Color="Color.Info"
						   OnClick="() => isDescriptionExpanded = !isDescriptionExpanded"
						   />
			<!-- Download -->
			<SafeNavLink EndIcon="@Icons.Material.Filled.Download"
						 Valid="!string.IsNullOrWhiteSpace(Attachment.AttachmentUrl)"
						 Href="@Attachment.AttachmentUrl"
						 Target="Target" />

			@if (Attachment is not null && CanDeleteTicketAttachment(Attachment))
		{
			<!-- Delete -->
			<SafeNavButton EndIcon="@Icons.Material.Filled.Delete"
			               Color="Color.Error"
						   Valid="!string.IsNullOrWhiteSpace(Attachment.AttachmentUrl)" 
						   Class="ms-auto"
						   OnClick="HandleDelete"/>

			
		}
		</MudCardActions>
	</MudCard>
}
@code {
	[Parameter, EditorRequired]
	public TicketAttachmentDTO Attachment { get; set; }

	[Parameter, EditorRequired]
	public EventCallback<int> OnDeleteRequested { get; set; }

	string extension = "default";
	bool isDescriptionExpanded = false;

	protected override void OnParametersSet()
	{
		extension = Path.GetExtension(Attachment.FileName)?.Trim('.') ?? "default";
	}

	private async Task HandleDelete()
	{
		if (Attachment is null) return;
		
		bool? confirmed = await DialogService.ShowMessageBox(
			title: "Confirm Deletion", 
			message: "Are you sure you want to delete this attachment?",
			yesText: "Yes, Delete",
			noText: "No, Cancel"
		);
		if (confirmed == true)
		{
			await OnDeleteRequested.InvokeAsync(Attachment.Id);
		}
	}

}
