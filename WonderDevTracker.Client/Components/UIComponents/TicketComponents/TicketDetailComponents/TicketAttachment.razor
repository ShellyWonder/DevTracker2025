@* TicketAttachment *@

@using MudBlazor
@inject ISnackbar Snackbar

<AnimatedCard Index="Index">
	<MudPaper Class="px-3">
		<MudCardHeader>
			<MudText Typo="Typo.h3" Color="Color.Primary">Attachments</MudText>
		</MudCardHeader>
		<div>
			@if (Ticket?.Attachments.Any() == true)
			{
				<div class="attachments-section">
					<div class="row row-cols-1 row-cols-md-4">
						@foreach (var attachment in Ticket.Attachments)
						{
							<div class="col mb-3">
								<AttachmentCard Attachment="attachment"
												OnDeleteRequested="OnDeleteRequested" />
							</div>
						}

					</div>

				</div>
			}
			else
			{
				<div class="d-flex align-items-center justify-content-center" style="min-height:150px;">
					<NotFoundDisplay Message="No Ticket Attachments to Display" />
				</div>

			}
			@if (UserCanEditTicket)
			{
				<!-- Open dialog -->
				//TODO: Disable button if ticket is resolved/archived
				<SafeNavButton TypeText="Upload Attachment"
							   Class="project-details-link py-3"
							   Color="Color.Secondary"
							   Disabled="false"
							   StartIcon="@Icons.Material.Filled.Add"
							   Variant="Variant.Text"
							   OnClick="ShowAttachmentDialog" />
			}
		</div>
	</MudPaper>
</AnimatedCard>

@*Attachment Dialog*@
<MudMessageBox @ref="_attachmentDialog"
			   Title="Upload Attachment"
			   CancelText="Cancel">
	<MessageContent>
		<MudFileUpload T="IBrowserFile"
					   Accept=".png,.jpg,.jpeg,.gif,.pdf,.doc,.docx,.xls,.xlsx,.txt"
					   FilesChanged="HandleFilesChange"
					   MaximumFileCount="1">
			<ActivatorContent>
				<div class="d-flex flex-column align-items-center">
					<MudCard>
						@{
							string? extension = Path.GetExtension(_selectedFile?.Name)?.Trim('.');
							if (string.IsNullOrEmpty(extension)) extension = "default";
						}
						<MudCardMedia Image="@($"/img/attachmentsPNGs/png/{extension}.png")"
									  Height="96"
									  Style="background-size:contain; border: 6px inset transparent;" />

						<MudCardContent>
							<MudText Typo="Typo.h6" Align="Align.Center">@(_selectedFile?.Name ?? "No File Selected")</MudText>
						</MudCardContent>
					</MudCard>

					<SafeNavButton TypeText="Select a File"
								   Color="Color.Primary"
								   Variant="Variant.Filled"
								   Class="my-3"
								   StartIcon="@Icons.Material.Filled.UploadFile"
								   OnClick="async () =>
														  		   {
															  		   if (_selectedFile is not null)
															  		   {
																  		   await OnUploadRequested.InvokeAsync(new AttachmentUploadRequest(_selectedFile, _newAttachment.Description ?? string.Empty));
																  		   _attachmentDialog?.Close();
															  		   }
														  		   }" />

				</div>
			</ActivatorContent>
		</MudFileUpload>
		<!-- Attachment Description Text Input -->
		<MudTextField T="string"
					  Variant="Variant.Outlined"
					  Label="Description"
					  @bind-Value="_newAttachment.Description"
					  For="()=> _newAttachment.Description" />
	</MessageContent>
	<YesButton>
		<DialogConfirmBtn TypeText="Upload"
						  Color="Color.Success"
						  Class="ms-2"
						  StartIcon="@Icons.Material.Filled.Upload"
						  OnClick="async () =>
				  								{
											  		if (_selectedFile is null) return;

											  		var req = new AttachmentUploadRequest(_selectedFile, _newAttachment.Description ?? string.Empty);
											  		await OnUploadRequested.InvokeAsync(req);

											  		_attachmentDialog?.Close();
										  		}" />
	</YesButton>
</MudMessageBox>

@code {
	[Parameter]
	public IEnumerable<TicketAttachmentDTO> Attachments { get; set; } = Array.Empty<TicketAttachmentDTO>();

	[Parameter, EditorRequired]
	public bool UserCanEditTicket { get; set; } = false;

	[Parameter, EditorRequired]
	public int Index { get; set; }

	[Parameter, EditorRequired]
	public TicketDTO Ticket { get; set; }

	[Parameter, EditorRequired]
	public EventCallback<AttachmentUploadRequest> OnUploadRequested { get; set; }

	[Parameter, EditorRequired]
	public EventCallback<int> OnDeleteRequested { get; set; }

	private MudMessageBox? _attachmentDialog = default!;

	private string _uploaderKey = Guid.NewGuid().ToString(); // forces a fresh input when changed

	private TicketAttachmentDTO _newAttachment = new() { AttachmentUrl = string.Empty };
	private IBrowserFile? _selectedFile;
	private bool _uploading = false;

	private void HandleFilesChange(IBrowserFile file)
	{
		_selectedFile = file;
		_newAttachment.FileName = _selectedFile?.Name ?? string.Empty;

	}

	private async Task ShowAttachmentDialog()
	{
		if (UserCanEditTicket && _attachmentDialog is null) return;

		if (_attachmentDialog is null) return;
		ResetAttachmentDraft();

		bool? result = await _attachmentDialog.ShowAsync();

		//if user confirmed upload
		if (result is not true)
		{
			ResetAttachmentDraft();
			return;

		}
		if (_selectedFile is null)
		{
			Snackbar.Add("No file selected for upload.", Severity.Error);
			return;
		}
		else
		{
			//pass to the parent component
			var req = new AttachmentUploadRequest(_selectedFile, _newAttachment.Description ?? string.Empty);
			await OnUploadRequested.InvokeAsync(req);
			_attachmentDialog?.Close();
			ResetAttachmentDraft();
		}

	}
	private async Task SubmitUploadAsync()
	{
		if (_uploading || _selectedFile is null) return;

		_uploading = true;
		try
		{
			var req = new AttachmentUploadRequest(
				_selectedFile,
				_newAttachment.Description ?? string.Empty);

			await OnUploadRequested.InvokeAsync(req);

			_attachmentDialog?.Close();
			ResetAttachmentDraft();
		}
		finally
		{
			_uploading = false;
		}
	}


	//reset state if user cancels
	private void ResetAttachmentDraft()
	{
		_selectedFile = null;
		_newAttachment.Description = string.Empty;
		_newAttachment.FileName = string.Empty;
	}

}
