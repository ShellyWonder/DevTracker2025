@* CompanyInviteTable *@
@using WonderDevTracker.Services.Interfaces
@inject IInviteDTOService InviteService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

@inherits AuthenticatedComponentBase

<MudDataGrid Items="Invites"
			 Elevation="0"
			 Dense="true"
			 RowsPerPage="10">
	<Columns>
		@if (Status == InviteStatusEnum.Pending)
		{
			@if (IsAdmin)
			{
				<TemplateColumn >
					<CellTemplate>
						<MudMenu Icon="@Icons.Material.Filled.MoreVert"
								 Dense
								 Size="Size.Small">
							<MudMenuItem Icon="@Icons.Material.Filled.Mail"
										 IconColor="Color.Dark"
										 OnClick="async () => await HandleResendInvite(context.Item.Id)">
								Resend
							</MudMenuItem>
							<MudMenuItem Icon="@Icons.Material.Filled.Cancel"
										 IconColor="Color.Error"
										 OnClick="async () => await HandleCancelInvite(context.Item.Id)">
								Cancel
							</MudMenuItem>
						</MudMenu>
					</CellTemplate>
				</TemplateColumn>
			}
		}
		<PropertyColumn Title="Name" Property="i => i.InviteeFullName">
			<CellTemplate>
				<NameEmailLink Invite="context.Item" />
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Title="Project" Property="@(i => i.Project!.Name)">
			<CellTemplate>
				<ProjectTitleLink Project="context.Item.Project" />
			</CellTemplate>
		</PropertyColumn>
		<PropertyColumn Title="Sent" Property="i => i.InviteDate" Format="g">
			<CellTemplate>
				<MudText Typo="Typo.caption">@context.Item.InviteDate.ToLocalTime().ToString("g")</MudText>
			</CellTemplate>
		</PropertyColumn>
	</Columns>
	<PagerContent>
		<MudDataGridPager />
	</PagerContent>
	<NoRecordsContent>
		<NotFoundDisplay Message="@GetEmptyMessage()" />
	</NoRecordsContent>
</MudDataGrid>

@code {
	#region PARAMETERS
	[Parameter, EditorRequired]
	public IEnumerable<InviteDTO> Invites { get; set; } = [];

	[Parameter, EditorRequired]
	public InviteStatusEnum Status { get; set; }

	[Parameter]
	public EventCallback OnChange { get; set; }
	#endregion

	private string GetEmptyMessage() => Status switch
	{
		InviteStatusEnum.Pending => "No pending invitations available.",
		InviteStatusEnum.Accepted => "No accepted invitations yet.",
		InviteStatusEnum.Cancelled => "No cancelled or expired invitations.",
		_ => "No invitations available."
	};

	#region PRIVATE HELPER METHODS
	private async Task HandleCancelInvite(int inviteId)
	{
		if (UserInfo is null || !IsAdmin) return;

		try
		{
			await InviteService.CancelInviteAsync(inviteId, UserInfo);
			Snackbar.Add("Invite cancelled successfully.", Severity.Success);
			await OnChange.InvokeAsync();
		}
		catch (Exception ex)
		{
			Console.WriteLine(ex);
			Snackbar.Add("Failed to cancel invite. Please try again.", Severity.Error);

		}
	}

	private async Task HandleResendInvite(int inviteId)
	{
		if (UserInfo is null || !IsAdmin) return;
		try
		{
			bool sent = await InviteService.SendInviteAsync(new Uri(NavManager.BaseUri), inviteId, UserInfo);
			if (sent)
			{
				Snackbar.Add("Invite resent successfully.", Severity.Success);
			}
			else
			{
				Snackbar.Add("Failed to resend invite. Please try again.", Severity.Error);
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine(ex);
			Snackbar.Add("Failed to resend invite. Please try again.", Severity.Error);
		}
	}
	#endregion
}
