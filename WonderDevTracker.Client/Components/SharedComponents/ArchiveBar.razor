@* ArchiveBar (presentational) *@
@if (UserCanArchiveAndRestore)
{
    <div class="d-flex gap-2">
        @if (!IsArchived)
        {
            <MudButton Variant="Variant.Text"
                       Color="Color.Error"
                       Disabled="@Busy"
                       StartIcon="@Icons.Material.Filled.Delete"
                       OnClick="OpenArchiveConfirmAsync"
                       aria-busy="@Busy">
                @if (Busy)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Archiving…</MudText>
                }
                else
                {
                    <MudText>Archive</MudText>
                }
            </MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Text"
                       Color="Color.Success"
                       Disabled="@Busy"
                       StartIcon="@Icons.Material.Filled.RestoreFromTrash"
                       OnClick="OpenRestoreConfirmAsync"
                       aria-busy="@Busy">
                @if (Busy)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Restoring…</MudText>
                }
                else
                {
                    <MudText>Restore</MudText>
                }
            </MudButton>
        }
    </div>

    <!-- Archive confirm -->
    <MudMessageBox @ref="_archiveBox"
                   Title="@($"Archive {ItemLabel}")"
                   CancelText="Cancel">
        <MessageContent>
            Are you sure you want to archive this @ItemLabel?
        </MessageContent>
        <YesButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Error"
                       Disabled="@Busy"
                       StartIcon="@Icons.Material.Filled.Delete"
                       OnClick="ConfirmArchiveAsync"
                       aria-busy="@Busy">
                @if (Busy)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Archiving…</MudText>
                }
                else
                {
                    <MudText>Yes, Archive</MudText>
                }
            </MudButton>
        </YesButton>
    </MudMessageBox>

    <!-- Restore confirm -->
    <MudMessageBox @ref="_restoreBox"
                   Title="@($"Restore {ItemLabel}")"
                   CancelText="Cancel">
        <MessageContent>
            Are you sure you want to restore this @ItemLabel?
        </MessageContent>
        <YesButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       Disabled="@Busy"
                       StartIcon="@Icons.Material.Filled.RestoreFromTrash"
                       OnClick="ConfirmRestoreAsync"
                       aria-busy="@Busy">
                @if (Busy)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Restoring…</MudText>
                }
                else
                {
                    <MudText>Yes, Restore</MudText>
                }
            </MudButton>
        </YesButton>
    </MudMessageBox>
}

@code {
    [Parameter] public bool IsArchived { get; set; }
    [Parameter] public bool UserCanArchiveAndRestore { get; set; } = false;

    /// <summary>Labels and dialog titles. Ex: "Project", "Ticket".</summary>
    [Parameter] public string ItemLabel { get; set; } = "Item";

    /// <summary>Raised when user confirms archive.</summary>
    [Parameter] public EventCallback OnArchiveRequested { get; set; }

    /// <summary>Raised when user confirms restore.</summary>
    [Parameter] public EventCallback OnRestoreRequested { get; set; }

    /// <summary>Parent-controlled busy state. Do NOT set this in the child.</summary>
    [Parameter] public bool Busy { get; set; }

    private MudMessageBox? _archiveBox;
    private MudMessageBox? _restoreBox;

    private async Task OpenArchiveConfirmAsync()
    {
        if (!UserCanArchiveAndRestore || Busy || _archiveBox is null) return;
        await _archiveBox.ShowAsync();
    }

    private async Task OpenRestoreConfirmAsync()
    {
        if (!UserCanArchiveAndRestore || Busy || _restoreBox is null) return;
        await _restoreBox.ShowAsync();
    }

    private async Task ConfirmArchiveAsync()
    {
        if (Busy) return; // parent also guards; this is extra safety
        if (OnArchiveRequested.HasDelegate)
            await OnArchiveRequested.InvokeAsync();
    }

    private async Task ConfirmRestoreAsync()
    {
        if (Busy) return;
        if (OnRestoreRequested.HasDelegate)
            await OnRestoreRequested.InvokeAsync();
    }
}
