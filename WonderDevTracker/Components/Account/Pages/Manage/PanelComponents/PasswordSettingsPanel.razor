@* ChangePassword Panel"*@

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<PasswordSettingsPanel> Logger

@inherits ServerAuthenticatedComponentBase

<MudDivider Light DividerType="DividerType.FullWidth" Class="my-3" />

<StatusMessage Message="@message" />

<div class="row">
	<div class="col-md-6">
		<EditForm Model="Input" FormName="change-password" OnValidSubmit="OnValidSubmitAsync" method="post" class="vstack gap-3">
			<DataAnnotationsValidator />
			<div>
				<MudTextField For="() => Input.OldPassword"
							  Immediate="true"
							  @bind-Value="Input.OldPassword"
							  name="Input.OldPassword"
							  autocomplete="old-password"
							  aria-required="true"
							  Variant="Variant.Outlined"
							  Label="Current password"
							  Placeholder="Please enter your current password."
							  ShrinkLabel
							  InputType="@(showOldPassword? InputType.Text: InputType.Password)"
							  Adornment="Adornment.End"
							  AdornmentIcon="@(showOldPassword? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
							  AdornmentAriaLabel="Toggle current password visibility"
							  OnAdornmentClick="@ToggleOldPasswordVisibility" />

			</div>
			<div>
				<MudTextField For="() => Input.NewPassword"
							  Immediate="true"
							  @bind-Value="Input.NewPassword"
							  name="Input.NewPassword"
							  autocomplete="new-password"
							  aria-required="true"
							  Label="New password"
							  Variant="Variant.Outlined"
							  Placeholder="Please enter your new password."
							  ShrinkLabel
							  InputType="@(showNewPassword? InputType.Text: InputType.Password)"
							  Adornment="Adornment.End"
							  AdornmentIcon="@(showNewPassword? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
							  AdornmentAriaLabel="Toggle new password visibility"
							  OnAdornmentClick="@ToggleNewPasswordVisibility" />
			</div>
			<div>
				<MudTextField For="() => Input.ConfirmPassword"
					          Immediate="true"
							  @bind-Value="Input.ConfirmPassword"
							  name="Input.ConfirmPassword"
							  autocomplete="new-password"
							  aria-required="true"
							  Label="Confirm new password"
							  Variant="Variant.Outlined"
							  Placeholder="Please confirm your new password."
							  ShrinkLabel
							  InputType="@(showConfirmPassword? InputType.Text: InputType.Password)"
							  Adornment="Adornment.End"
							  AdornmentIcon="@(showConfirmPassword? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
							  AdornmentAriaLabel="Toggle confirm password visibility"
							  OnAdornmentClick="@ToggleConfirmPasswordVisibility" />
			</div>
			<PanelBtnGroup SaveDisplayText="Update Password"
						   SaveStartIcon="@Icons.Material.Filled.LockReset" />
		</EditForm>
	</div>
</div>


@code {
	private string? message;
	private ApplicationUser user = default!;
	private bool hasPassword;

	[CascadingParameter]
	private HttpContext? HttpContext { get; set; }

	[SupplyParameterFromForm]
	private InputModel Input { get; set; } = new();

	//visibility flags
	private bool showOldPassword;
	private bool showNewPassword;
	private bool showConfirmPassword;

	protected override async Task OnInitializedWithAuthAsync()
	{
		if (AuthUser is null) throw new InvalidOperationException("AuthUser is not available.");
		user = await UserAccessor.GetRequiredUserAsync(AuthUser);
		hasPassword = await UserManager.HasPasswordAsync(user);
		if (!hasPassword)
		{
			RedirectManager.RedirectTo("Account/Manage/SetPassword");
		}
	}

	private async Task OnValidSubmitAsync()
	{
		var changePasswordResult = await UserManager.ChangePasswordAsync(user, Input.OldPassword, Input.NewPassword);
		if (!changePasswordResult.Succeeded)
		{
			message = $"Error: {string.Join(",", changePasswordResult.Errors.Select(error => error.Description))}";
			return;
		}

		Logger.LogInformation("User changed their password successfully.");

		if (HttpContext is not null)
		{

			RedirectManager.RedirectToCurrentPageWithStatus("Your password has been changed.", HttpContext);
		}
		else
		{
			message = "Your password has been changed.";
		}
	}
	// NEW: toggle helpers
	private void ToggleOldPasswordVisibility() => showOldPassword = !showOldPassword;
	private void ToggleNewPasswordVisibility() => showNewPassword = !showNewPassword;
	private void ToggleConfirmPasswordVisibility() => showConfirmPassword = !showConfirmPassword;


	private sealed class InputModel
	{
		[Required]
		[DataType(DataType.Password)]
		[Display(Name = "Current password")]
		public string OldPassword { get; set; } = "";

		[Required]
		[StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
		[DataType(DataType.Password)]
		[Display(Name = "New password")]
		public string NewPassword { get; set; } = "";

		[DataType(DataType.Password)]
		[Display(Name = "Confirm new password")]
		[Compare("NewPassword", ErrorMessage = "The new password and confirmation password do not match.")]
		public string ConfirmPassword { get; set; } = "";
	}
}

