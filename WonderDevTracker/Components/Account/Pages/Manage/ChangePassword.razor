@page "/Account/Manage/ChangePassword"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using WonderDevTracker.Client.Components.SharedComponents
@using WonderDevTracker.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<ChangePassword> Logger

<PageTitle>Change password | DevTracker</PageTitle>

<TitleComponentPage Title="Change Password" />
<MudDivider Light DividerType="DividerType.FullWidth" Class="my-3" />
<StatusMessage Message="@message" />
<div class="row">
	<div class="col-md-6">
		<EditForm Model="Input" FormName="change-password" OnValidSubmit="OnValidSubmitAsync" method="post" class="vstack gap-3">
			<DataAnnotationsValidator />
			<ValidationSummary class="text-danger" role="alert" />
			<div>
				<MudTextField For="() => Input.OldPassword"
							  @bind-Value="Input.OldPassword"
							  name="Input.OldPassword"
							  autocomplete="old-password"
							  aria-required="true"
							  Variant="Variant.Outlined"
							  Label="Current password"
							  Placeholder="Please enter your current password."
							  ShrinkLabel />

			</div>
			<div>
				<MudTextField For="() => Input.NewPassword"
							  @bind-Value="Input.NewPassword"
							  name="Input.NewPassword"
							  autocomplete="new-password"
							  aria-required="true"
							  Label="New password"
							  Variant="Variant.Outlined"
							  Placeholder="Please enter your new password."
							  ShrinkLabel />

			</div>
			<div>
				<MudTextField For="() => Input.ConfirmPassword"
							  @bind-Value="Input.ConfirmPassword"
							  name="Input.ConfirmPassword"
							  autocomplete="new-password"
							  aria-required="true"
							  Label="Confirm new password"
							  Variant="Variant.Outlined"
							  Placeholder="Please confirm your new password."
							  ShrinkLabel />
			</div>
			<div>
				<MudButton ButtonType="ButtonType.Submit"
						   Color="Color.Primary"
						   Size="Size.Large"
						   Variant="Variant.Filled"
						   StartIcon="@Icons.Material.Filled.Save"
						   FullWidth>
					Update Password
				</MudButton>
			</div>
		</EditForm>
	</div>
</div>

@code {
	private string? message;
	private ApplicationUser user = default!;
	private bool hasPassword;

	[CascadingParameter]
	private HttpContext HttpContext { get; set; } = default!;

	[SupplyParameterFromForm]
	private InputModel Input { get; set; } = new();

	protected override async Task OnInitializedAsync()
	{
		user = await UserAccessor.GetRequiredUserAsync(HttpContext);
		hasPassword = await UserManager.HasPasswordAsync(user);
		if (!hasPassword)
		{
			RedirectManager.RedirectTo("Account/Manage/SetPassword");
		}
	}

	private async Task OnValidSubmitAsync()
	{
		var changePasswordResult = await UserManager.ChangePasswordAsync(user, Input.OldPassword, Input.NewPassword);
		if (!changePasswordResult.Succeeded)
		{
			message = $"Error: {string.Join(",", changePasswordResult.Errors.Select(error => error.Description))}";
			return;
		}

		await SignInManager.RefreshSignInAsync(user);
		Logger.LogInformation("User changed their password successfully.");

		RedirectManager.RedirectToCurrentPageWithStatus("Your password has been changed", HttpContext);
	}

	private sealed class InputModel
	{
		[Required]
		[DataType(DataType.Password)]
		[Display(Name = "Current password")]
		public string OldPassword { get; set; } = "";

		[Required]
		[StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
		[DataType(DataType.Password)]
		[Display(Name = "New password")]
		public string NewPassword { get; set; } = "";

		[DataType(DataType.Password)]
		[Display(Name = "Confirm new password")]
		[Compare("NewPassword", ErrorMessage = "The new password and confirmation password do not match.")]
		public string ConfirmPassword { get; set; } = "";
	}
}
