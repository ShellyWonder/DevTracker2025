@page "/Account/Manage"
@rendermode InteractiveServer
@using WonderDevTracker.Components.Account.Pages.Manage.PanelComponents
@using Microsoft.AspNetCore.WebUtilities


@inject NavigationManager NavManager

<PageTitle>Account Settings | DevTracker</PageTitle>


<TitleComponentPage Title="Account Hub" />
<MudDivider Light DividerType="DividerType.FullWidth" Class="my-3" />
@if (ShowMessage)
{
	<StatusMessage Message="@MessageText" />
}
<MudTabs @bind-ActivePanelIndex="activeTabIndex"
		 Rounded="true"
		 Elevation="0"
		 Class="dt-settings-tabs">

	<MudTabPanel Text="Profile"
				 Icon="@Icons.Material.Filled.Person">
		<ProfileSettingsPanel />
	</MudTabPanel>

	<MudTabPanel Text="Email"
				 Icon="@Icons.Material.Filled.Email">
		<EmailSettingsPanel />
	</MudTabPanel>

	<MudTabPanel Text="Password"
				 Icon="@Icons.Material.Filled.Lock">
		<PasswordSettingsPanel />
	</MudTabPanel>
	@*TODO: Implement Two-Factor Auth*@
	@*TODO: Implement TabIndex to 3;*@
	@*TODO: Change PersonalData TabIndex to 4;*@
	@* <MudTabPanel Text="Two-Factor Authentication"
                     Icon="@Icons.Material.Filled.VerifiedUser">
            <TwoFactorSettingsPanel />
        </MudTabPanel> *@

	<MudTabPanel Text="Personal Data"
				 Icon="@Icons.Material.Filled.ManageAccounts">
		<PersonalDataSettingsPanel />
	</MudTabPanel>

</MudTabs>


@code {
	private bool ShowMessage { get; set; }
	private string? MessageText { get; set; }
	private int activeTabIndex = 0;

	protected override async Task OnInitializedAsync()
	{
		var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
		var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

		if (query["updated"] == "profile")
		{
			MessageText = "Your profile has been updated.";
			ShowMessage = true;

			// Auto-dismiss after 4 seconds (adjust as desired)
			_ = DismissAfterDelay(4000);
		}

		//tab selection
		var tabValue = query["tab"];
		if (int.TryParse(tabValue, out var index))
		{
			activeTabIndex = index;
		}


	}

	private async Task DismissAfterDelay(int milliseconds)
	{
		await Task.Delay(milliseconds);
		ShowMessage = false;
		StateHasChanged();
	}
}
